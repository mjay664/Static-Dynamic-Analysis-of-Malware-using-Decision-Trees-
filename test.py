import os
import json
import pickle
from csv import writer


summary_list = ['file_written', 'regkey_deleted', 'mutex', 'connects_ip', 'regkey_read', 'tls_master', 'regkey_written', 
                'command_line', 'regkey_opened', 'file_failed', 'file_opened', 'dll_loaded', 'file_copied', 'file_deleted',
                'connects_host', 'file_moved', 'file_recreated', 'guid', 'file_created', 'directory_enumerated', 'file_exists', 
                'file_read', 'resolves_host', 'directory_created', 'directory_removed']

net_keys = ['udp', 'http', 'icmp', 'smtp', 'tcp']

feature_header = [i for i in range(33)]


def extractfeatures(dir, add_label=False, malware_flag=0):
    feature_table = []
    file_name_table = []
    x = os.listdir(dir)
    for i in x:
        file_name_table.append(i.replace('.json', ''))
        features = []
        with open(os.path.join(dir, i)) as f:
            data = json.load(f)
            f.close()

            # from info section
            if data['info'].get('duration', 0) != 0:
                features.append(data['info']['duration'])
            else:
                features.append(0)
            
            if data['info'].get('score', 0) != 0:
                features.append(data['info']['score'])
            else:
                features.append(0)

            # from target section
            if data['target']['file'].get('size', 0) != 0:
                features.append(data['target']['file']['size'])
            else:
                features.append(0)

            #from network section
            for k in net_keys:
                if data['network'].get(k, 0) != 0:
                    features.append(len(data['network'][k]))
                else:
                    features.append(0)
            
            # from behavior section
            summary = data['behavior']['summary']
            for k in summary_list:
                if summary.get(k, 0) != 0:
                    features.append(len(summary[k]))
                else:
                    features.append(0)
                    
        # if add_label:
        #     features.append(malware_flag)

        feature_table.append(features)
        
    return feature_table, file_name_table


if __name__ == "__main__":
    path = input('Enter the path: ')

    features, files = extractfeatures(path)

    model = pickle.load(open('dt_model_dynamic', 'rb'))

    predictions = model.predict(features)
    final_list = []
    for i in range(len(predictions)):
        if predictions[i]:
            final_list.append([files[i], 'M'])
        else:
            final_list.append([files[i], 'B'])

    with open("out.csv", "w", newline="") as f:
        writer = writer(f)
        writer.writerow(['FILE_HASH', 'Predicted Label'])
        writer.writerows(final_list)
    



# df = pd.read_excel('features.xlsx')

# df = df.sample(frac=1)

# X = df.drop(33, axis=1)
# y = df[33]

# from sklearn.model_selection import train_test_split

# X_train, X_test, y_train, y_test = train_test_split(X, y, random_state=1)

# from sklearn import tree
# clf = tree.DecisionTreeClassifier()
# clf.fit(X_train, y_train)

# # from sklearn.svm import SVC
# # clf = SVC(gamma='auto')
# # clf.fit(X_train, y_train)

# # from sklearn.neighbors import KNeighborsClassifier
# # clf = KNeighborsClassifier(n_neighbors=3)
# # clf.fit(X_train, y_train)

# y_predict = clf.predict(X_test)

# from sklearn.metrics import accuracy_score
# print(accuracy_score(y_test, y_predict))
# from sklearn.metrics import confusion_matrix
# print(confusion_matrix(y_test, y_predict))

    